ğŸ§ª PROMPT MAESTRO â€” QA E2E COMPLETO (TheCookFlow)

ğŸ‘‰ Pega esto directamente en Replit (Agent/Workspace).
Este script probarÃ¡ toda la app end-to-end.

1ï¸âƒ£ Dependencias

Ejecuta en tu shell Replit:

npm i -D @playwright/test
npx playwright install --with-deps

2ï¸âƒ£ Archivo de configuraciÃ³n general

playwright.config.ts

import { defineConfig, devices } from '@playwright/test';
import 'dotenv/config';

export default defineConfig({
  testDir: 'tools/qa/e2e',
  timeout: 120_000,
  retries: 0,
  use: {
    baseURL: process.env.QA_WEB_BASE || 'http://localhost:5173',
    headless: true,
    ignoreHTTPSErrors: true,
    video: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
});

3ï¸âƒ£ Script de prueba completo

tools/qa/e2e/thecookflow-full.e2e.spec.ts

import { test, expect } from "@playwright/test";

test.describe("ğŸŒ TheCookFlow â€” flujo completo Freemium â†’ PRO", () => {
  test.beforeEach(async ({ page }) => {
    // Simular el puente Android (Billing + Ads)
    await page.addInitScript(() => {
      (window as any).Android = {
        getUserId: () => "e2e-user",
        openSubscription: () => {
          console.log("ğŸ’³ SimulaciÃ³n Play Billing: prueba gratuita iniciada");
          (window as any).__purchaseTriggered = true;
        },
        setPro: (flag: boolean) => {
          console.log(`ğŸ‘‘ Modo PRO: ${flag}`);
          (window as any).__isPro = flag;
        },
      };
    });
  });

  test("âœ… Registro â†’ Trial â†’ Cuestionario+Foto â†’ MenÃº â†’ Lista â†’ Ads â†’ PRO â†’ CancelaciÃ³n", async ({ page }) => {
    const base = process.env.QA_WEB_BASE || "http://localhost:5173";
    const API = process.env.QA_API_BASE || "http://localhost:3000";
    const userId = "e2e-user";

    console.log("ğŸŒ URL Web:", base);
    console.log("ğŸ”Œ URL API:", API);

    // 1ï¸âƒ£ Registro
    await page.goto(`${base}/register`);
    await page.getByRole("textbox", { name: /email/i }).fill(`qa_${Date.now()}@tcf.test`);
    await page.getByRole("textbox", { name: /contraseÃ±a|password/i }).fill("123456");
    await page.getByRole("button", { name: /registrar|crear|continuar/i }).click();
    await page.waitForLoadState("networkidle");
    console.log("âœ… Registro completado");

    // 2ï¸âƒ£ Activar prueba gratuita
    await page.goto(`${base}/pricing`);
    await page.getByRole("button", { name: /prueba gratuita|activar prueba/i }).click();
    await expect(async () => {
      const triggered = await page.evaluate(() => window.__purchaseTriggered);
      expect(triggered).toBeTruthy();
    }).toPass();
    console.log("âœ… Prueba gratuita activada (mock)");

    // 3ï¸âƒ£ Cuestionario
    await page.goto(`${base}/questionnaire`);
    await page.getByLabel(/personas/i).fill("2");
    await page.getByLabel(/presupuesto/i).fill("25");
    await page.getByLabel(/tiempo/i).selectOption("rapido");
    await page.getByLabel(/objetivo/i).selectOption("ahorro");

    // Subir foto de nevera (simulada)
    const fileChooserPromise = page.waitForEvent("filechooser");
    await page.getByRole("button", { name: /subir foto|nevera/i }).click();
    const fc = await fileChooserPromise;
    const buf = Buffer.from("89504e470d0a1a0a", "hex");
    await fc.setFiles({ name: "fridge.png", mimeType: "image/png", buffer: buf });
    await page.getByRole("button", { name: /guardar|continuar/i }).click();
    await page.waitForTimeout(500);
    console.log("âœ… Cuestionario completado con foto");

    // 4ï¸âƒ£ Generar primer menÃº
    await page.goto(`${base}/menu-generator`);
    await page.getByRole("button", { name: /generar/i }).click();
    await page.waitForSelector("text=âœ… MenÃº generado", { timeout: 25_000 });
    console.log("âœ… Primer menÃº generado correctamente");

    // 5ï¸âƒ£ Ver menÃº semanal
    await page.goto(`${base}/menu-generated`);
    await expect(page.getByText(/Lunes|Martes|Mi[eÃ©]rcoles|Jueves|Viernes/)).toBeVisible();
    console.log("âœ… MenÃº semanal visible");

    // 6ï¸âƒ£ Generar lista de la compra
    await page.goto(`${base}/lista`);
    await expect(page.getByText(/Verduras|Despensa|Prote[iÃ­]na/i)).toBeVisible();
    console.log("âœ… Lista de la compra generada");

    // 7ï¸âƒ£ Simular fin de trial â†’ plan FREE
    await page.evaluate(async (API) => {
      await fetch(`${API}/api/billing/cancel`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: "e2e-user" }),
      });
    }, API);
    await page.waitForTimeout(500);
    console.log("âš™ï¸ Trial cancelado â†’ modo FREE");

    // 8ï¸âƒ£ Intentar otro menÃº (debe pedir ver anuncio)
    await page.goto(`${base}/menu-generator`);
    await page.getByRole("button", { name: /generar/i }).click();
    await expect(page.locator("text=Debes ver un anuncio")).toBeVisible();
    console.log("âœ… LÃ­mite detectado â†’ se requiere anuncio");

    // 9ï¸âƒ£ Simular anuncio y desbloqueo
    await page.evaluate(async (API) => {
      await fetch(`${API}/api/unlock-after-ad`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: "e2e-user" }),
      });
    }, API);
    await page.waitForTimeout(500);
    await page.getByRole("button", { name: /generar/i }).click();
    await page.waitForSelector("text=âœ… MenÃº generado", { timeout: 20_000 });
    console.log("âœ… Desbloqueo tras anuncio funcionando");

    // ğŸ”Ÿ Simular compra PRO (deeplink)
    await page.evaluate(() => {
      window.dispatchEvent(new CustomEvent("tcf:deeplink", { detail: { userId: "e2e-user", token: "abcOK" } }));
    });
    await page.waitForTimeout(1000);
    const pro = await page.evaluate(() => window.__isPro);
    expect(pro).toBeTruthy();
    console.log("âœ… Compra verificada â†’ plan PRO activo");

    // 1ï¸âƒ£1ï¸âƒ£ Verificar generaciÃ³n ilimitada (ya sin ads)
    await page.goto(`${base}/menu-generator`);
    await page.getByRole("button", { name: /generar/i }).click();
    await page.waitForSelector("text=âœ… MenÃº generado", { timeout: 20_000 });
    console.log("âœ… GeneraciÃ³n ilimitada funcionando");

    // 1ï¸âƒ£2ï¸âƒ£ Cancelar suscripciÃ³n final
    await page.evaluate(async (API) => {
      await fetch(`${API}/api/billing/cancel`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: "e2e-user" }),
      });
    }, API);
    await page.waitForTimeout(500);
    console.log("âœ… SuscripciÃ³n cancelada correctamente");

    console.log("ğŸ‰ TEST E2E COMPLETO EXITOSO ğŸš€");
  });
});

4ï¸âƒ£ Comando de ejecuciÃ³n

Ejecuta el test en Replit:

npx playwright test tools/qa/e2e/thecookflow-full.e2e.spec.ts


O aÃ±ade un script en package.json:

"qa:e2e:full": "npx playwright test tools/qa/e2e/thecookflow-full.e2e.spec.ts"


y luego:

npm run qa:e2e:full

5ï¸âƒ£ QuÃ© prueba exactamente este E2E
Etapa	AcciÃ³n	Resultado esperado
ğŸŸ¢ Registro	Formulario completo y redirecciÃ³n exitosa.	Usuario creado.
ğŸ’³ Inicio prueba gratuita	Simula Google Play Billing.	window.__purchaseTriggered = true.
ğŸ“‹ Cuestionario completo + foto nevera	Rellena datos, sube foto y guarda.	Respuestas guardadas correctamente.
ğŸ³ Generar primer menÃº	IA crea menÃº semanal.	Muestra â€œâœ… MenÃº generadoâ€.
ğŸ“… Ver menÃº y lista compra	Tabla semanal + lista agrupada.	Todo visible correctamente.
ğŸ§± Fin de trial â†’ FREE	API /api/billing/cancel ejecutada.	Plan pasa a â€œfreeâ€.
ğŸš« LÃ­mite alcanzado	Intenta otro menÃº â†’ muestra â€œDebes ver un anuncioâ€.	Bloqueo confirmado.
ğŸ¬ Anuncio visto (rewarded)	Simula /api/unlock-after-ad.	Nuevo menÃº permitido.
ğŸ‘‘ Compra PRO (deeplink)	Dispara evento tcf:deeplink.	Plan PRO activo, __isPro = true.
âš¡ GeneraciÃ³n ilimitada	Puede crear menÃºs sin lÃ­mite.	Sin anuncios ni bloqueos.
âŒ CancelaciÃ³n final	/api/billing/cancel ejecutado.	Vuelve a plan FREE.
6ï¸âƒ£ Ejemplo de salida esperada en consola
ğŸŒ URL Web: http://localhost:5173
ğŸ”Œ URL API: http://localhost:3000
âœ… Registro completado
âœ… Prueba gratuita activada (mock)
âœ… Cuestionario completado con foto
âœ… Primer menÃº generado correctamente
âœ… MenÃº semanal visible
âœ… Lista de la compra generada
âš™ï¸ Trial cancelado â†’ modo FREE
âœ… LÃ­mite detectado â†’ se requiere anuncio
âœ… Desbloqueo tras anuncio funcionando
âœ… Compra verificada â†’ plan PRO activo
âœ… GeneraciÃ³n ilimitada funcionando
âœ… SuscripciÃ³n cancelada correctamente
ğŸ‰ TEST E2E COMPLETO EXITOSO ğŸš€

7ï¸âƒ£ Notas finales

El test es autÃ³nomo y no destruye datos reales, usa un usuario temporal e2e-user.

Puedes ejecutarlo tantas veces como quieras.

Si tienes variables distintas para URLs, crea un .env.qa:

QA_WEB_BASE=https://app.thecookflow.com
QA_API_BASE=https://api.thecookflow.com


âœ… Con este E2E:

Se validan todas las funciones del modelo Freemium â†’ PRO.

Se comprueba la IA (menÃºs, recetas, listas).

Se testea la integraciÃ³n con anuncios y pagos.

Se asegura que el flujo del usuario real funciona de principio a fin.