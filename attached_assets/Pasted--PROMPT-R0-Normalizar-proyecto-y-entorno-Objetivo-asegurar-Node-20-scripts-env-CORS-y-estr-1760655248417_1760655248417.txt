ðŸ”§ PROMPT R0 â€” Normalizar proyecto y entorno

Objetivo: asegurar Node 20, scripts, .env, CORS y estructura mÃ­nima.

ActÃºa sobre mi repo en Replit y realiza:

1) Node y scripts:
- Asegura Node 20 + npm/pnpm.
- Crea/actualiza package.json con scripts:
  "dev": "node server/index.js",
  "start": "node server/index.js",
  "build": "echo 'no build'"

2) Estructura mÃ­nima:
- server/index.js
- server/services/ai.js        (stub IA)
- server/services/billing.js   (stub Play Billing)
- server/middleware/security.js
- public/                      (estÃ¡ticos si hace falta)

3) .env.example con:
OPENAI_API_KEY=
PERPLEXITY_API_KEY=
PORT=3000
ALLOWED_ORIGINS=http://localhost:5173,https://app.thecookflow.com,https://thecookflow.com
UPLOAD_DIR=./uploads
BILLING_PROVIDER=play

4) AÃ±ade .replit para arrancar con "npm run dev".

ðŸ§  PROMPT R1 â€” API Express segura (CORS + rate limit + health)

Objetivo: levantar Express con seguridad bÃ¡sica y /api/health.

En server/index.js:
- Express + cors + helmet + morgan/pino-http + rate-limit.
- Lee process.env.PORT (default 3000) y ALLOWED_ORIGINS (separado por comas).
- CORS: solo orÃ­genes permitidos, methods GET/POST, credentials: false.
- Rutas:
  GET /api/health -> { ok:true, ts:Date.now(), env:process.env.NODE_ENV || 'dev' }

- Manejo de errores global: {error, code, path, ts}.

Exporta app.listen(PORT) y log â€œAPI on :PORTâ€.

ðŸ³ PROMPT R2 â€” Endpoint /api/chef (stub IA listo para crecer)

Objetivo: â€œengancharâ€ tu asistente IA con un servicio adaptable.

Crea server/services/ai.js con funciÃ³n:
  async function generate({prompt, alergias=[], presupuesto, tiempo, imageUrl}) {
    // Si existe OPENAI_API_KEY: llama a OpenAI; si no, devuelve mock
    // Devuelve objeto { result: "receta/menÃº con ingredientes, pasos, sustituciones, precio aprox" }
  }
Exporta { generate }.

En server/index.js:
- POST /api/chef  body: {prompt, alergias?, presupuesto?, tiempo?, imageUrl?}
- Valida contenido mÃ­nimo (prompt string).
- Llama a ai.generate y responde {result}.
- Rate-limit mÃ¡s estricto para /api/chef (p.ej., 30/15min por IP).


Esto deja preparada la evoluciÃ³n a â€œvisiÃ³n con foto de neveraâ€.

ðŸ’³ PROMPT R3 â€” Suscripciones: /api/subscription-status y /api/billing/verify

Objetivo: activar el modelo freemium/PRO (mock verificaciÃ³n Play listo para producciÃ³n).

Crea server/services/billing.js:
- Mapa en memoria: const PLANS = new Map(); // userId -> {active:true, plan:'pro', updatedAt}
- async function verifyPlay({userId, purchaseToken}) {
    // MOCK: si purchaseToken termina en 'OK' => activo; si no => false
    const active = typeof purchaseToken === 'string' && purchaseToken.endsWith('OK');
    if (active) PLANS.set(userId, {active:true, plan:'pro', updatedAt:Date.now()});
    return {active, plan: active ? 'pro' : 'free'};
  }
- function getStatus(userId) { return PLANS.get(userId) || {active:false, plan:'free'}; }
Exporta { verifyPlay, getStatus }.

En server/index.js:
- GET /api/subscription-status?userId=...  -> devuelve getStatus(userId)
- POST /api/billing/verify {userId, purchaseToken} -> llama verifyPlay y devuelve {active, plan}


â€œVerificaciÃ³n inicial con /api/subscription-statusâ€ y pricing mensual de tu checklist.

ðŸ–¼ï¸ PROMPT R4 â€” Subida de imagen (nevera): /api/upload

Objetivo: aceptar 1 imagen, devolver imageUrl servible.

En server/index.js:
- AÃ±ade multer (storage en carpeta UPLOAD_DIR del .env, por defecto ./uploads). Limite 4MB, sÃ³lo image/*.
- Sirve estÃ¡tico /uploads con cache-control privado o corto.
- POST /api/upload (campo 'file') -> guarda y devuelve { imageUrl: "/uploads/<filename>" }.
- Crea carpeta si no existe. Nota: para producciÃ³n moveremos a S3/Cloudflare R2; aquÃ­ basta local.

Seguridad:
- Valida mimetype (jpeg/png/webp).
- Rechaza >4MB con 413.

ðŸ”’ PROMPT R5 â€” Seguridad y calidad (helmet CSP, payloads, logs)

Objetivo: evitar sorpresas en producciÃ³n.

En server/middleware/security.js:
- helmet() con:
  - contentSecurityPolicy bÃ¡sica: default-src 'self' https:;
  - referrerPolicy: 'no-referrer';
  - hidePoweredBy, xssFilter (via helmet), noSniff.
- JSON body limit 1mb, urlencoded 1mb.
- Sanitiza prompt (trim, length < 2.5k, sin binarios).
- Logger de latencias simple (Date.now dif).

En server/index.js usa middleware/security.js antes de rutas.

ðŸ§ª PROMPT R6 â€” QA rÃ¡pido vÃ­a scripts y curl

Objetivo: comprobar que todo responde.

Crea scripts npm:
  "qa:api": "node tools/qa/health-check.js"

Crea tools/qa/health-check.js que:
- Haga fetch a http://localhost:3000/api/health y verifique ok:true
- Haga fetch a http://localhost:3000/api/subscription-status?userId=testpro
- Imprima resultados y exit(1) si algo falla

AÃ±ade README con ejemplos curl:
- curl http://localhost:3000/api/health
- curl -XPOST http://localhost:3000/api/billing/verify -H "content-type: application/json" -d '{"userId":"u1","purchaseToken":"abcOK"}'
- curl http://localhost:3000/api/subscription-status?userId=u1

ðŸŒ PROMPT R7 â€” CORS exacto y producciÃ³n

Objetivo: que WebApp y Android WebView entren sin problemas.

Ajusta CORS para:
- OrÃ­genes permitidos: https://app.thecookflow.com, https://thecookflow.com, http://localhost:5173
- MÃ©todos: GET, POST
- Headers: Content-Type, Accept, x-utm-source, x-utm-medium (si los usas)
- credentials: false

AÃ±ade respuesta a OPTIONS para /api/*.

ðŸ§© PROMPT R8 â€” Bridge WebApp Â«tcfÂ»

Objetivo: que tu WebApp sepa hablar con la app nativa y con la API.

Crea public/tcf-bridge.js (o en tu bundle web) con:

window.tcf = {
  getUserId() {
    if (window.Android?.getUserId) return window.Android.getUserId();
    return localStorage.getItem('uid') || (localStorage.setItem('uid', crypto.randomUUID()), localStorage.getItem('uid'));
  },
  async status() {
    const uid = this.getUserId();
    const r = await fetch(`/api/subscription-status?userId=${encodeURIComponent(uid)}`);
    return r.json(); // {active, plan}
  },
  openSubscription() {
    const uid = this.getUserId();
    if (window.Android?.openSubscription) return window.Android.openSubscription(uid);
    // fallback web: redirigir a Play
    location.href = 'https://play.google.com/store/apps/details?id=com.thecookflow.app';
  },
  setPro(active) { if (window.Android?.setPro) window.Android.setPro(!!active); }
};

// Deep link/compra desde la app:
window.addEventListener('tcf:deeplink', async (e) => {
  const {userId, token} = e.detail || {};
  if (!token) return;
  await fetch('/api/billing/verify', {
    method:'POST',
    headers:{'content-type':'application/json'},
    body: JSON.stringify({userId, purchaseToken: token})
  });
  window.tcf.setPro(true);
});


Esto encaja con el flujo deeplink/verify que quieres en Android.

ðŸ§± PROMPT R9 â€” Gating Free/PRO (lÃ­mite simple sin DB)

Objetivo: limitar llamadas al chef en FREE; desbloquear al ser PRO.

En tu WebApp (ej. store o hook):
- Genera userId con tcf.getUserId().
- Al enviar a /api/chef, antes consulta tcf.status():
  - Si active:false -> aplica tope diario: guarda en localStorage "chef_count_<YYYYMMDD>" y corta cuando >=3 (muestra modal paywall con botÃ³n tcf.openSubscription()).
  - Si active:true -> sin lÃ­mites y llama tcf.setPro(true) para ocultar Ads en Android.

AÃ±ade un pequeÃ±o componente Paywall que se active al superar el lÃ­mite.

ðŸ“¦ PROMPT R10 â€” Replit Secrets y arranque

Objetivo: dejarlo corriendo en Replit sin dolores.

En Replit â†’ Secrets:
- AÃ±ade OPENAI_API_KEY (si vas a usar IA real).
- (Opcional) PERPLEXITY_API_KEY.
- ALLOWED_ORIGINS = https://app.thecookflow.com,https://thecookflow.com,http://localhost:5173
- UPLOAD_DIR = ./uploads

En Shell:
- npm i
- npm run dev   # o usa el botÃ³n Run

Pruebas:
- Abre la URL de Replit /api/health  -> {ok:true}
- Ejecuta curl de R6.

âœ… PROMPT R11 â€” Checklist de validaciÃ³n final

Objetivo: asegurar que la app Android/WebView ya puede integrarse.

1) /api/health responde {ok:true}.
2) /api/billing/verify con token "OK" marca PRO; /api/subscription-status devuelve {active:true, plan:'pro'} para ese userId.
3) /api/upload acepta una imagen <4MB y devuelve imageUrl servible.
4) CORS: llamadas desde https://app.thecookflow.com funcionan (sin errores en consola).
5) WebApp: lÃ­mite 3 usos/dÃ­a de /api/chef si FREE; modal paywall muestra botÃ³n tcf.openSubscription().
6) WebApp: al volverse PRO, oculta Ads en Android (tcf.setPro(true)).